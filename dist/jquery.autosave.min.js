/**
 * @fileOverview jQuery.autosave
 *
 * @author Kyle Florence
 * @website https://github.com/kflorence/jquery-autosave
 * @version 1.0.0b
 *
 * Inspired by the jQuery.autosave plugin written by Raymond Julin,
 * Mads Erik Forberg and Simen Graaten.
 *
 * Dual licensed under the MIT and BSD Licenses.
 */
(function(c,f){var g=function(i,h,j){if(i!=="change"){c(h).bind(i,j)}else{i=(h.type=="checkbox"||h.tagName.toLowerCase()=="select"&&h.multiple)&&("onpropertychange" in document.body)?"propertychange":"change";c(h).bind(i,function(k){if(k.type=="change"||(k.type=="propertychange"&&/^(checked|selectedIndex)$/.test(window.event.propertyName))){j.call(this,k)}})}};var a=function(i){var h=c(i);return h.filter(function(){return(this.elements||this.form)})};var e=function(i){var h=a(i);return h.map(function(){return this.elements?c.makeArray(this.elements):this})};var d=function(i){var h=a(i);return c(c.unique(h.map(function(){return this.elements?this:this.form}).get()))};var b=function(k,h){var j={},i=typeof k;if(i==="function"){j.method=k}else{if(i==="string"&&k in h){j=h[k]}else{if(i==="object"){j=k,i=typeof j.method;if(i==="string"&&j.method in h){j=h[j.method];if(typeof k.options==="object"){j.options=c.extend(true,{},j.options,k.options)}else{j.options={}}}}}}return j};c.fn.autosave=function(i){var j=d(this),h=c.extend({},c.autosave);j.data("autosave",h);h.initialize(j,i);return this};c.autosave={timer:0,$queue:c({}),callbacks:{},options:{namespace:"autosave",save:{trigger:"change",scope:false,data:false,condition:false,method:"ajax"},events:{save:"save",saved:"saved"},classes:{changed:"changed",ignore:"ignore"}},initialize:function(k,j){var h=this,i=e(k);c.extend(this,{$forms:k,$fields:i,options:c.extend(true,{},this.options,j)});c.each(this.options.events,function(m,l){h.options.events[m]=[l,h.options.namespace].join(".")});c.each(this.options.classes,function(l,m){h.options.classes[l]=[h.options.namespace,m].join("-")});i.each(function(){g("change",this,function(l){c(this).addClass(h.options.classes.changed)})});k.bind(this.options.events.save,function(l){h.save(this,l.type)});c.each(this.options.save,function(m,n){var l=[];if(n){if(!c.isArray(n)){n=[n]}c.each(n,function(o,p){p=b(p,h.callbacks[m]);if(c.isFunction(p.method)){l.push(p)}})}h.options.save[m]=l});c.each(this.options.save.trigger,function(m,l){l.method.call(h,l.options)})},startInterval:function(i){var h=this;i=i||this.interval;if(this.timer){this.stopInterval()}if(!isNaN(parseInt(i))){this.timer=setTimeout(function(){h.save(false,h.timer)},i)}},stopInterval:function(){clearTimeout(this.timer);this.timer=null},save:function(h,k){var i=this,m=false,j=h?e(h):this.$fields;if(this.options.save.method.length){c.each(this.options.save.scope,function(o,p){j=p.method.call(i,p.options,j)});j=j.filter(function(){return !c(this).hasClass(i.options.classes.ignore)});if(j.length){var l=true,n=j.serializeArray();c.each(this.options.save.data,function(o,p){n=p.method.call(i,p.options,j,n)});c.each(this.options.save.condition,function(o,p){return(l=p.method.call(i,p.options,j,n,k))!==false});if(l){c.each(this.options.save.method,function(o,p){i.$queue.queue("saveMethodQueue",function(){if(p.method.call(i,p.options,n)!==false){i.complete()}})});m=true}}}this.complete(m)},complete:function(i){var h=this.$queue.queue("saveMethodQueue");if(h&&h.length){this.$queue.dequeue("saveMethodQueue")}if(h&&!h.length){this.$forms.triggerHandler(this.options.events.saved)}if(!h||!h.length){if(i!==false){this.$fields.removeClass(this.options.classes.changed)}if(this.timer){this.startInterval()}}}};c.extend(c.autosave.callbacks,{trigger:{change:{method:function(j){var h=this,i=j.filter?this.$fields.filter(j.filter):this.$fields;i.each(function(){g("change",this,function(l,k){h.save(k,l.type)})})},options:{filter:false}},event:{method:function(j){var i=this,h=c(j.element);if(typeof j.eventType==="string"){h.each(function(){g(j.eventType,this,function(k){i.save(false,k.type)})})}},options:{element:".autosave-save",eventType:"click"}},interval:{method:function(h){if(!isNaN(parseInt(h.interval))){this.startInterval(this.interval=h.interval)}},options:{interval:30000}}},scope:{changed:{method:function(i,h){return h.filter("."+this.options.classes.changed)}}},data:{serializeObject:function(i,h){var j={};c.each(h.serializeArray(),function(l,m){var p=m.name,k=m.value;j[p]=j[p]===f?k:c.isArray(j[p])?j[p].concat(k):[j[p],k]});return j}},condition:{interval:{method:function(j,i,k,h){return(!this.timer||this.timer===h)}},changed:{method:function(i,h){return h.filter("."+this.options.classes.changed).length>0}}},method:{ajax:{method:function(i,j){var h=this;c.ajax(c.extend(true,{data:j},i,{complete:function(l,k){if(c.isFunction(i.complete)){i.complete.apply(h,arguments)}h.complete()}}));return false},options:{url:window.location.href,type:"POST"}}}})})(jQuery);
