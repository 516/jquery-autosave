/**
 * @fileOverview jQuery.autosave
 *
 * @author Kyle Florence
 * @website https://github.com/kflorence/jquery-autosave
 * @version 1.0.1b
 *
 * Inspired by the jQuery.autosave plugin written by Raymond Julin,
 * Mads Erik Forberg and Simen Graaten.
 *
 * Dual licensed under the MIT and BSD Licenses.
 */
(function(c,b){var h=c.extend;if(!c.isPlainObject){var k={},d=Object.prototype.hasOwnProperty;c.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(m,l){k["[object "+l+"]"]=l.toLowerCase()});var i=function(l){return l==null?String(l):k[toString.call(l)]||"object"},a=function(l){return l&&typeof l==="object"&&"setInterval" in l},e=Array.isArray||function(l){return i(l)==="array"},j=function(m){if(!m||i(m)!=="object"||m.nodeType||a(m)){return false}if(m.constructor&&!d.call(m,"constructor")&&!d.call(m.constructor.prototype,"isPrototypeOf")){return false}var l;for(l in m){}return l===b||d.call(m,l)};h=function(){var u,n,l,m,r,s,q=arguments[0]||{},p=1,o=arguments.length,t=false;if(typeof q==="boolean"){t=q;q=arguments[1]||{};p=2}if(typeof q!=="object"&&!jQuery.isFunction(q)){q={}}if(o===p){q=this;--p}for(;p<o;p++){if((u=arguments[p])!=null){for(n in u){l=q[n];m=u[n];if(q===m){continue}if(t&&m&&(j(m)||(r=e(m)))){if(r){r=false;s=l&&e(l)?l:[]}else{s=l&&j(l)?l:{}}q[n]=h(t,s,m)}else{if(m!==b){q[n]=m}}}}}return q}}var g=function(m,l,n){if(m!=="change"){c(l).bind(m,n)}else{m=(l.type=="checkbox"||l.tagName.toLowerCase()=="select"&&l.multiple)&&("onpropertychange" in document.body)?"propertychange":"change";c(l).bind(m,function(o){if(o.type=="change"||(o.type=="propertychange"&&/^(checked|selectedIndex)$/.test(window.event.propertyName))){n.call(this,o)}})}};c.fn.autosave=function(m){var l=h({},c.autosave);l.initialize(this,m);return this};c.autosave={timer:0,$queue:c({}),options:{namespace:"autosave",save:{trigger:"change",scope:false,data:false,condition:false,method:"ajax"},events:{save:"save",saved:"saved"},classes:{changed:"changed",ignore:"ignore"}},initialize:function(n,m){var l=this;this.selector=n.selector;this.options=h(true,{},this.options,m);this.update();if(!this.$elements.length){return}c.each(this.options.events,function(p,o){l.options.events[p]=[o,l.options.namespace].join(".")});c.each(this.options.classes,function(o,p){l.options.classes[o]=[l.options.namespace,p].join("-")});this.$fields.each(function(){g("change",this,function(o){c(this).addClass(l.options.classes.changed)})});this.$forms.bind(this.options.events.save,function(o){l.save(this,o.type)});c.each(this.options.save,function(p,q){var o=[];if(q){if(!c.isArray(q)){q=[q]}c.each(q,function(r,s){s=l.getCallback(s,l.callbacks[p]);if(c.isFunction(s.method)){o.push(s)}})}l.options.save[p]=o});c.each(this.options.save.trigger,function(p,o){o.method.call(l,o.options)})},getFormsAndFields:function(l){return c(l).filter(function(){return(this.elements||this.form)})},getForms:function(l){return c(c.unique(c(l||this.$elements).map(function(){return this.elements?this:this.form}).get()))},getFields:function(l){return c(l||this.$elements).map(function(){return this.elements?c.makeArray(this.elements):this})},getValidFields:function(l){var m=this;return c(l||this.$fields).filter(function(){return !c(this).hasClass(m.options.classes.ignore)})},getChangedFields:function(l){return c(l||this.$fields).filter("."+this.options.classes.changed)},getCallback:function(o,l){var n={},m=typeof o;if(m==="function"){n.method=o}else{if(m==="string"&&o in l){n=l[o]}else{if(m==="object"){n=o,m=typeof n.method;if(m==="string"&&n.method in l){n=l[n.method];if(typeof o.options==="object"){n.options=h(true,{},n.options,o.options)}else{n.options={}}}}}}return n},startInterval:function(m){var l=this;m=m||this.interval;if(this.timer){this.stopInterval()}if(!isNaN(parseInt(m))){this.timer=setTimeout(function(){l.save(false,l.timer)},m)}},stopInterval:function(){clearTimeout(this.timer);this.timer=null},update:function(){if(this.$elements&&this.$elements.length){this.$elements.removeData("autosave")}this.$elements=this.getFormsAndFields(this.selector);this.$elements.data("autosave",this);this.$forms=this.getForms(this.$elements);this.$fields=this.getFields(this.$elements)},save:function(l,o){var m=this,q=false;this.update();l=l||this.$fields;if(this.options.save.method.length){var n=this.getValidFields(l);c.each(this.options.save.scope,function(s,t){n=t.method.call(m,t.options,n)});if(n.length){var p=true,r=n.serializeArray();c.each(this.options.save.data,function(s,t){r=t.method.call(m,t.options,n,r)});c.each(this.options.save.condition,function(s,t){return(p=t.method.call(m,t.options,n,r,o))!==false});if(p){c.each(this.options.save.method,function(s,t){m.$queue.queue("saveMethodQueue",function(){if(t.method.call(m,t.options,r)!==false){m.complete()}})});q=true}}}this.complete(q)},complete:function(m){var l=this.$queue.queue("saveMethodQueue");if(l&&l.length){this.$queue.dequeue("saveMethodQueue")}if(l&&!l.length){this.$forms.triggerHandler(this.options.events.saved)}if(!l||!l.length){if(m!==false){this.$fields.removeClass(this.options.classes.changed)}if(this.timer){this.startInterval()}}}};var f=c.autosave.callbacks={};c.each(c.autosave.options.save,function(l){f[l]={}});h(f.trigger,{change:{method:function(n){var l=this,m=n.filter?this.$fields.filter(n.filter):this.$fields;m.each(function(){g("change",this,function(p,o){l.save(o,p.type)})})},options:{filter:false}},event:{method:function(n){var m=this,l=c(n.element);if(typeof n.eventType==="string"){l.each(function(){g(n.eventType,this,function(o){m.save(false,o.type)})})}},options:{element:".autosave-save",eventType:"click"}},interval:{method:function(l){if(!isNaN(parseInt(l.interval))){this.startInterval(this.interval=l.interval)}},options:{interval:30000}}});h(f.scope,{changed:{method:function(){return this.getChangedFields()}}});h(f.data,{serializeObject:{method:function(m,l){var n={};c.each(l.serializeArray(),function(q,r){var s=r.name,p=r.value;n[s]=n[s]===b?p:c.isArray(n[s])?n[s].concat(p):[n[s],p]});return n}}});h(f.condition,{interval:{method:function(n,m,o,l){return(!this.timer||this.timer===l)}},changed:{method:function(){return this.getChangedFields().length>0}}});h(f.method,{ajax:{method:function(m,n){var l=this;c.ajax(c.extend(true,{data:n},m,{complete:function(p,o){if(c.isFunction(m.complete)){m.complete.apply(l,arguments)}l.complete()}}));return false},options:{url:window.location.href,type:"POST"}}})})(jQuery);
